// ============================================================================
// CONFIGURA√á√ÉO DO FIREBASE (PREENCHA AQUI)
// ============================================================================
const FIREBASE_CONFIG = {
  email: "firebase-adminsdk-fbsvc@talents-c856d.iam.gserviceaccount.com",
  key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCNRvTVgSfW5iDd\na+g7kxkKIL8dxCj/DJ05mcioq/nICieQx0pqxy2fKUD6gFl81Pv4k2sNGPkZ2lX5\nr5ZVZ0W2wB4GQB9a74skxfqsPKPNx/U/blg911och6EWVozPpshWQfkE2HfhaGWm\n5b0vLxMlToMSkmG27Sfm/W8XSLM8xNPPkvPrDXvUvolNMfmTF0tSl7Ydl3K7xifZ\nnKbgoCukbMVSLi1yEnlzhHyPxKb4rbAKjo4YCoQuS3qDZi3Cnpi9EF1uL9cVjjnS\n6cJrtPPF8rQErjc/6cCQVHDyqAni5kY6MUH+8TmbJognqjOTmiBsey8drLU8rhSx\n2Ej/rIQbAgMBAAECggEAAOMWq3aFpQRJ5YoFacZZLGabPJkcNsnB/PgZufFmfpqN\nuAuATJ5Wi37LUSdYKH//2wY18F2dRsvHqWswUvX0ipq3NYvWhpAlfAQgOE+jKaod\nQJo1RKIjBzXUzZqahL1D2cLNSPoA+rHYnY0ovHCbuqq9CPNRWMAxdXJW7br/oRyK\n4oUjYnuRD78efHxTn517JfF23LnALLU9zhUoZ68BWswCN/1IyrpOJE9XIpnu2W68\noyqZ4622czH2GOnKWLlDDnQF+ww8Rd31XDOd9dwHS1+MPFePaxhCIwv+rBZV3GSW\n+IQBNxWJ7LHgOn4m+aSI7vnKPsZ2TAd3fXsAUoDytQKBgQC/uyto4aVT9ElQK7/e\nb2Szxg4LeGK+TLcsFwQHIowkln43SVradCNFvTgc9El5J/Yl7pps+shuhWt6DqKS\nJfgn1QFbyoBu6NX5afdrjBTxD6Jy/imvyE1yuFbOgzR7cG/iTBEJQcj1eJuKCc1P\nqIZDmiQFyjG415gSgs3z4TeMjwKBgQC8ojtup8Pj3xnwRzM0Xwtj9eqGwXEcqeaJ\nti1RJMhqtztgT279IfTh1RqjdD7dVcu29irXOEGxjn2GmYnmkWJ00P2g2zrfPu2c\nsb+JR4ZofS1ZC58eO8cV+YDDqtvK9hIA8s6UwapIWCs8GUVs6TR55hvsUXwvaeYX\n/ZZuT78ttQKBgEOZt6WEIamnMQ4uTrkbp3LnOt56dL5KCC9ocggd+zGPSjMuDvWF\nC0a0f4td6mXoXBZluVcBWRf2vL1NWa6T6poItTDrBjuUppUI8q6dtmiELa/Dw2jy\nA7SWIC0x/5giPaCZV0xfQH6kJpsV96jFb4l4WIkeEEfu4/Rq4DjDyLUrAoGAdcVA\nH+0kU1/WXPrHEFqKzQUbQLkDeubkpXQVRQUXD/GIY7AUVnxd3KVlNUn9ecj4ICn/\nQ1G/SjDxVBkGTOrWMqLMxyI41mr+hQdA01/RnekRZ/fmh0TBHoohB4jkIwqQ4QC3\nU466VuKdU69fdgj/l1/AbUHOq/eNDctooUSu0sUCgYEAnAc8AYDZrlKoaBi7t0+v\nTXHbbB9x0j1TgzW1kyfKYp2T+FGpT8sMsvcvu75a6/tQY8m9xAJGJwY+C97DWLTR\nYuvA5PLt4WCoMRBpg5ibxdp7Z2/+xLbkRhuaTypa07B7+cdARcSiMVX/bFX82q6i\ngnKX4qEqQa2PeX1T5gHPDOU=\n-----END PRIVATE KEY-----\n",
  projectId: "talents-c856d"
};

const FIRESTORE_BATCH_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents:commit`;

// Nome exato da coluna que usaremos para controle (Crie ela na planilha!)
const NOME_COLUNA_CONTROLE = "Status Firebase"; 

// ============================================================================
// FUN√á√ÉO PRINCIPAL
// ============================================================================
function enviarDadosParaFirebase() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const dataRange = sheet.getDataRange();
  const data = dataRange.getDisplayValues();
  
  if (data.length < 2) {
    Logger.log("Planilha vazia.");
    return;
  }

  const headers = data[0];
  
  // Localiza o √≠ndice da coluna de Status (come√ßa em 0)
  const indexStatus = headers.indexOf(NOME_COLUNA_CONTROLE);
  if (indexStatus === -1) {
    Browser.msgBox(`ERRO: Crie uma coluna chamada "${NOME_COLUNA_CONTROLE}" na planilha antes de rodar.`);
    return;
  }

  const rows = data.slice(1); // Dados sem cabe√ßalho
  
  // Filtra apenas as linhas que N√ÉO t√™m "Enviado" na coluna de status
  // Guardamos o 'index' original para saber onde escrever o "Enviado" depois
  const linhasPendentes = rows.map((row, index) => {
    return { rowData: row, originalIndex: index + 2 }; // +2 porque pula cabe√ßalho e array come√ßa em 0
  }).filter(item => item.rowData[indexStatus] !== "Enviado");

  const total = linhasPendentes.length;

  if (total === 0) {
    Logger.log("Nada novo para enviar.");
    return;
  }
  
  Logger.log(`üìä Encontradas ${total} novas linhas para processar...`);

  const BATCH_SIZE = 450; 
  const totalLotes = Math.ceil(total / BATCH_SIZE);
  let loteAtual = 0;
  let totalEnviado = 0;
  let totalErros = 0;

  Logger.log(`üì¶ Processando em ${totalLotes} lote(s) de at√© ${BATCH_SIZE} registros cada...`);

  for (let i = 0; i < total; i += BATCH_SIZE) {
    loteAtual++;
    const loteItens = linhasPendentes.slice(i, i + BATCH_SIZE);
    
    Logger.log(`‚è≥ Processando lote ${loteAtual}/${totalLotes} (${loteItens.length} registro(s))...`);
    
    // Prepara as opera√ß√µes de escrita
    const writes = [];
    const linhasParaMarcar = [];

    loteItens.forEach(item => {
      const candidato = mapearColunasParaApp(headers, item.rowData);
      const operacao = criarOperacaoDeEscrita(candidato);
      
      if (operacao) {
        writes.push(operacao);
        linhasParaMarcar.push(item.originalIndex);
      }
    });

    if (writes.length > 0) {
      // 1. Tenta enviar para o Firebase
      try {
        Logger.log(`  üì§ Enviando ${writes.length} registro(s) para o Firebase...`);
        enviarLoteFirestore(writes);
        
        // 2. Se deu certo, marca como "Enviado" na planilha
        linhasParaMarcar.forEach(rowIndex => {
          // getRange(linha, coluna). O indexStatus √© base 0, getRange usa base 1, ent√£o +1
          sheet.getRange(rowIndex, indexStatus + 1).setValue("Enviado");
        });

        totalEnviado += writes.length;
        Logger.log(`  ‚úÖ Lote ${loteAtual} processado com sucesso! (${totalEnviado} de ${total} enviados at√© agora)`);
        
      } catch (e) {
        totalErros += writes.length;
        Logger.log(`  ‚ùå Erro ao enviar lote ${loteAtual}: ${e.message}`);
        Logger.log(`  ‚ö†Ô∏è  ${writes.length} registro(s) n√£o foram marcados como enviados e ser√£o tentados novamente na pr√≥xima execu√ß√£o`);
        // Se der erro, n√£o marcamos como enviado, assim tentar√° de novo na pr√≥xima execu√ß√£o
      }
    }
    
    // Pausa entre lotes para evitar limite de taxa (apenas se n√£o for o √∫ltimo lote)
    if (loteAtual < totalLotes) {
      Utilities.sleep(500); // Pausa de 500ms entre lotes
    }
  }
  
  // Resumo final
  Logger.log("=".repeat(50));
  Logger.log(`üìà RESUMO DA EXECU√á√ÉO:`);
  Logger.log(`  ‚úÖ Total enviado com sucesso: ${totalEnviado}`);
  Logger.log(`  ‚ùå Total com erro: ${totalErros}`);
  Logger.log(`  üìä Total processado: ${totalEnviado + totalErros} de ${total}`);
  Logger.log("=".repeat(50));
}

// ============================================================================
// MAPEAMENTO (MANTIDO IGUAL, APENAS PEQUENO AJUSTE DE SEGURAN√áA)
// ============================================================================
function mapearColunasParaApp(headers, rowData) {
  const candidato = {};
  
  headers.forEach((header, index) => {
    const valor = String(rowData[index]).trim(); 
    if (valor === "") return;

    const h = header.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    // Ignora a pr√≥pria coluna de controle para n√£o enviar "Status: Enviado" para o banco
    if (h === NOME_COLUNA_CONTROLE.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")) return;

    if (h.includes("carimbo") || h.includes("timestamp")) {
      candidato["original_timestamp"] = valor;
      candidato["createdAt"] = formatarData(valor) || new Date().toISOString(); 
    }
    else if (h.includes("nome completo")) candidato["fullName"] = valor;
    else if (h.includes("foto atual")) candidato["photoUrl"] = valor;
    else if (h.includes("data de nascimento")) candidato["birthDate"] = formatarData(valor);
    else if (h.includes("idade")) candidato["age"] = valor;
    else if (h.includes("e-mail principal") || (h.includes("mail") && !h.includes("endereco"))) candidato["email"] = valor;
    else if (h.includes("endereco de e-mail")) { if (!candidato["email"]) candidato["email"] = valor; }
    else if (h.includes("telefone") || h.includes("celular") || h.includes("whatsapp")) candidato["phone"] = valor;
    else if (h.includes("cidade onde reside")) candidato["city"] = normalizarCidade(valor);
    else if (h.includes("estado civil")) candidato["maritalStatus"] = valor;
    else if (h.includes("cnh")) candidato["hasLicense"] = valor;
    else if (h.includes("filhos")) candidato["childrenCount"] = valor;
    else if (h.includes("areas de interesse")) candidato["interestAreas"] = valor;
    else if (h.includes("formacao")) candidato["education"] = valor;
    else if (h.includes("nivel de escolaridade")) candidato["schoolingLevel"] = valor;
    else if (h.includes("instituicao de ensino")) candidato["institution"] = valor;
    else if (h.includes("data de formatura")) candidato["graduationDate"] = formatarData(valor);
    else if (h.includes("cursando neste momento")) candidato["isStudying"] = valor;
    else if (h.includes("experiencias anteriores")) candidato["experience"] = valor;
    else if (h.includes("campo livre")) candidato["freeField"] = valor;
    else if (h.includes("referencias profissionais")) candidato["references"] = valor;
    else if (h.includes("cursos e certificacoes")) candidato["courses"] = valor;
    else if (h.includes("certificacoes profissionais")) { 
       candidato["courses"] = candidato["courses"] ? candidato["courses"] + "\n" + valor : valor; 
    }
    else if (h.includes("anexar curriculo")) candidato["cvUrl"] = valor;
    else if (h.includes("portfolio")) candidato["portfolioUrl"] = valor;
    else if (h.includes("encontrou")) candidato["source"] = valor;
    else if (h.includes("indicado por")) candidato["referral"] = valor;
    else if (h.includes("candidatando a uma vaga")) candidato["typeOfApp"] = valor;
    else if (h.includes("expectativa salarial")) candidato["salaryExpectation"] = valor;
    else if (h.includes("mudanca de cidade")) candidato["canRelocate"] = valor;
    else if (h.includes("etapa_funil")) candidato["status"] = valor; 
    else if (h.includes("data primeira entrevista")) candidato["firstInterviewDate"] = formatarData(valor);
    else if (h.includes("data segunda entrevista")) candidato["secondInterviewDate"] = formatarData(valor);
    else if (h.includes("dados dos testes")) candidato["testData"] = valor;
    else if (h.includes("feedback")) candidato["feedback"] = valor;
    else if (h === "id") candidato["sheetId"] = valor; 
  });

  if (!candidato["fullName"]) return null;
  
  if (!candidato["status"]) candidato["status"] = "Inscrito"; 
  if (!candidato["createdAt"]) candidato["createdAt"] = new Date().toISOString();
  candidato["imported"] = true;

  return candidato;
}

// ============================================================================
// AUXILIARES (MANTER IGUAIS)
// ============================================================================
function criarOperacaoDeEscrita(data) {
  if (!data) return null;
  const uniqueString = (data.email || "sem_email") + "_" + (data.original_timestamp || data.createdAt || "sem_data");
  const docId = Utilities.base64EncodeWebSafe(Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, uniqueString));
  const collectionPath = `projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents/candidates/${docId}`;
  
  const fields = {};
  for (const key in data) {
    fields[key] = { stringValue: String(data[key]) };
  }

  return { update: { name: collectionPath, fields: fields } };
}

function enviarLoteFirestore(writes) {
  const token = getServiceAccountToken();
  const payload = { writes: writes };
  const options = {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: "Bearer " + token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(FIRESTORE_BATCH_URL, options);
  const statusCode = response.getResponseCode();
  
  if (statusCode !== 200) {
    const errorText = response.getContentText();
    Logger.log(`  ‚ö†Ô∏è  Resposta do Firebase: Status ${statusCode}`);
    Logger.log(`  ‚ö†Ô∏è  Erro: ${errorText}`);
    throw new Error(`Erro Firebase (${statusCode}): ${errorText}`);
  }
  
  // Log de sucesso (opcional, pode comentar se gerar muito log)
  // Logger.log(`  ‚úì Firebase retornou: ${statusCode} (${writes.length} registro(s) processados)`);
}

function getServiceAccountToken() {
  const privateKey = FIREBASE_CONFIG.key.replace(/\\n/g, '\n');
  const clientEmail = FIREBASE_CONFIG.email;
  const header = { alg: "RS256", typ: "JWT" };
  const now = Math.floor(Date.now() / 1000);
  const claim = { iss: clientEmail, scope: "https://www.googleapis.com/auth/datastore", aud: "https://oauth2.googleapis.com/token", exp: now + 3600, iat: now };
  const toSign = Utilities.base64EncodeWebSafe(JSON.stringify(header)) + "." + Utilities.base64EncodeWebSafe(JSON.stringify(claim));
  const signature = Utilities.base64EncodeWebSafe(Utilities.computeRsaSha256Signature(toSign, privateKey));
  const jwt = toSign + "." + signature;
  const params = { method: "post", payload: { grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer", assertion: jwt }, muteHttpExceptions: true };
  const response = UrlFetchApp.fetch("https://oauth2.googleapis.com/token", params);
  const json = JSON.parse(response.getContentText());
  if (json.error) throw new Error("Erro Token: " + json.error_description);
  return json.access_token;
}

function formatarData(valor) {
  if (!valor) return "";
  if (!isNaN(valor) && valor > 20000) { 
     const date = new Date((valor - 25569) * 86400 * 1000);
     return date.toISOString().split('T')[0];
  }
  return String(valor).trim();
}

// ============================================================================
// NORMALIZA√á√ÉO DE CIDADES
// ============================================================================
function normalizarCidade(city) {
  if (!city || typeof city !== 'string') return "";
  
  const normalized = city.trim();
  const lowerCity = normalized.toLowerCase();
  
  // Remove acentos para compara√ß√£o mais flex√≠vel
  const removeAccents = function(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  };
  
  const lowerCityNoAccents = removeAccents(lowerCity);
  
  // Cidades principais com suas varia√ß√µes
  const mainCities = {
    'Porto Alegre/RS': ['porto alegre', 'porto alegre/rs', 'poa', 'poa/rs', 'portoalegre', 'porto alegre rs', 'p. alegre', 'p. alegre/rs'],
    'Canoas/RS': ['canoas', 'canoas/rs', 'canoas rs'],
    'Bag√©/RS': ['bag√©', 'bage', 'bag√©/rs', 'bage/rs', 'bag√© rs', 'bage rs'],
    'Santo Ant√¥nio da Patrulha/RS': ['santo ant√¥nio da patrulha', 'santo antonio da patrulha', 'sto ant√¥nio da patrulha', 'sto antonio da patrulha', 'santo ant patrulha', 'sto ant patrulha', 'sap', 'sap/rs', 'sap rs', 'santo ant√¥nio da patrulha/rs', 'santo antonio da patrulha/rs', 'sto ant√¥nio da patrulha/rs', 'sto antonio da patrulha/rs', 'santo ant patrulha/rs', 'sto ant patrulha/rs'],
    'Gua√≠ba/RS': ['gua√≠ba', 'guaiba', 'gua√≠ba/rs', 'guaiba/rs', 'gua√≠ba rs', 'guaiba rs'],
    'Os√≥rio/RS': ['os√≥rio', 'osorio', 'os√≥rio/rs', 'osorio/rs', 'os√≥rio rs', 'osorio rs'],
    'Tramanda√≠/RS': ['tramanda√≠', 'tramandai', 'tramanda√≠/rs', 'tramandai/rs', 'tramanda√≠ rs', 'tramandai rs', 'tramandai/rs'],
    'S√£o Borja/RS': ['s√£o borja', 'sao borja', 's√£o borja/rs', 'sao borja/rs', 's√£o borja rs', 'sao borja rs', 's borja', 's borja/rs'],
    "Sant'Ana do Livramento/RS": ["sant'ana do livramento", "santana do livramento", "sant'ana do livramento/rs", "santana do livramento/rs", "sant'ana do livramento rs", "santana do livramento rs", "sant ana do livramento", "sant ana do livramento/rs", "livramento", "livramento/rs", "livramento rs"],
    'Cruz Alta/RS': ['cruz alta', 'cruz alta/rs', 'cruz alta rs', 'cruzalta', 'cruzalta/rs'],
    'Itaqui/RS': ['itaqui', 'itaqui/rs', 'itaqui rs'],
    'Alegrete/RS': ['alegrete', 'alegrete/rs', 'alegrete rs'],
    'Arroio do Sal/RS': ['arroio do sal', 'arroio do sal/rs', 'arroio do sal rs', 'arroio sal', 'arroio sal/rs', 'arroio sal rs'],
    'Torres/RS': ['torres', 'torres/rs', 'torres rs']
  };
  
  // Procura nas cidades principais
  for (const [standardName, variations] of Object.entries(mainCities)) {
    // Verifica se √© exatamente igual (case-insensitive)
    if (lowerCity === standardName.toLowerCase()) {
      return standardName;
    }
    
    // Verifica varia√ß√µes
    for (let i = 0; i < variations.length; i++) {
      const variation = variations[i];
      const lowerVariation = variation.toLowerCase();
      const lowerVariationNoAccents = removeAccents(lowerVariation);
      
      // Match exato
      if (lowerCity === lowerVariation || lowerCityNoAccents === lowerVariationNoAccents) {
        return standardName;
      }
      
      // Match parcial (para casos como "SAP" dentro de "SAP/RS")
      if (lowerCity.indexOf(lowerVariation) !== -1 || lowerVariation.indexOf(lowerCity) !== -1) {
        // Verifica se n√£o √© muito gen√©rico (ex: "RS" sozinho)
        if (lowerVariation.length > 2 && lowerCity.length > 2) {
          return standardName;
        }
      }
    }
    
    // Verifica se o nome padr√£o est√° contido no input
    const lowerStandard = standardName.toLowerCase();
    const lowerStandardNoAccents = removeAccents(lowerStandard);
    
    if (lowerCity.indexOf(lowerStandardNoAccents) !== -1 || lowerStandardNoAccents.indexOf(lowerCity) !== -1) {
      // Verifica se n√£o √© muito gen√©rico
      if (lowerStandard.length > 5 && lowerCity.length > 5) {
        return standardName;
      }
    }
  }
  
  // Se n√£o encontrou, tenta limpar e padronizar formato b√°sico
  const words = normalized.split(/\s+/);
  const cleaned = words.map(function(word) {
    if (word.length === 0) return '';
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  
  // Se termina com /RS, mant√©m; se n√£o, adiciona se for do RS
  if (cleaned.indexOf('/') === -1 && !cleaned.match(/\b(RS|SC|PR|SP|RJ|MG|ES|BA|SE|AL|PE|PB|RN|CE|PI|MA|PA|AP|AM|AC|RO|RR|TO|GO|MT|MS|DF)\b/i)) {
    return cleaned + '/RS';
  }
  
  return cleaned;
}

// ============================================================================
// CONFIGURA√á√ÉO DE GATILHOS AUTOM√ÅTICOS
// ============================================================================
/**
 * Configura gatilhos autom√°ticos para sincroniza√ß√£o
 * Execute esta fun√ß√£o UMA VEZ para configurar os gatilhos
 */
function setupTriggers() {
  // Remove gatilhos existentes com os mesmos nomes para evitar duplicatas
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'enviarDadosParaFirebase' || 
        trigger.getHandlerFunction() === 'checkNewSubmissions') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // Cria gatilho di√°rio para verificar novos cadastros na planilha
  // Executa todos os dias √†s 2h da manh√£
  ScriptApp.newTrigger('checkNewSubmissions')
    .timeBased()
    .everyDays(1)
    .atHour(2)
    .create();
  
  Logger.log("‚úÖ Gatilhos configurados com sucesso!");
  Logger.log("   - Gatilho di√°rio (checkNewSubmissions) √†s 2h da manh√£");
  Logger.log("   - Para novos formul√°rios, execute enviarDadosParaFirebase manualmente ou configure gatilho do Form");
}

/**
 * Verifica novos cadastros na planilha e sincroniza com Firebase
 * Esta fun√ß√£o √© chamada automaticamente pelo gatilho di√°rio
 * Tamb√©m pode ser executada manualmente quando necess√°rio
 */
function checkNewSubmissions() {
  try {
    Logger.log("üîç Verificando novos cadastros na planilha...");
    enviarDadosParaFirebase();
    Logger.log("‚úÖ Verifica√ß√£o conclu√≠da!");
  } catch (e) {
    Logger.log("‚ùå Erro ao verificar novos cadastros: " + e.message);
    // Envia email de notifica√ß√£o se configurado (opcional)
    // MailApp.sendEmail("seu-email@exemplo.com", "Erro na sincroniza√ß√£o", e.message);
  }
}
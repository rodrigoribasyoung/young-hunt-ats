// ============================================================================
// CONFIGURA√á√ÉO DO FIREBASE
// ============================================================================
// IMPORTANTE: Use as credenciais do Service Account do Firebase
// Arquivo JSON: talents-c856d-firebase-adminsdk-fbsvc-36a7b79743.json
const FIREBASE_CONFIG = {
  email: "firebase-adminsdk-fbsvc@talents-c856d.iam.gserviceaccount.com",
  key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCNRvTVgSfW5iDd\na+g7kxkKIL8dxCj/DJ05mcioq/nICieQx0pqxy2fKUD6gFl81Pv4k2sNGPkZ2lX5\nr5ZVZ0W2wB4GQB9a74skxfqsPKPNx/U/blg911och6EWVozPpshWQfkE2HfhaGWm\n5b0vLxMlToMSkmG27Sfm/W8XSLM8xNPPkvPrDXvUvolNMfmTF0tSl7Ydl3K7xifZ\nnKbgoCukbMVSLi1yEnlzhHyPxKb4rbAKjo4YCoQuS3qDZi3Cnpi9EF1uL9cVjjnS\n6cJrtPPF8rQErjc/6cCQVHDyqAni5kY6MUH+8TmbJognqjOTmiBsey8drLU8rhSx\n2Ej/rIQbAgMBAAECggEAAOMWq3aFpQRJ5YoFacZZLGabPJkcNsnB/PgZufFmfpqN\nuAuATJ5Wi37LUSdYKH//2wY18F2dRsvHqWswUvX0ipq3NYvWhpAlfAQgOE+jKaod\nQJo1RKIjBzXUzZqahL1D2cLNSPoA+rHYnY0ovHCbuqq9CPNRWMAxdXJW7br/oRyK\n4oUjYnuRD78efHxTn517JfF23LnALLU9zhUoZ68BWswCN/1IyrpOJE9XIpnu2W68\noyqZ4622czH2GOnKWLlDDnQF+ww8Rd31XDOd9dwHS1+MPFePaxhCIwv+rBZV3GSW\n+IQBNxWJ7LHgOn4m+aSI7vnKPsZ2TAd3fXsAUoDytQKBgQC/uyto4aVT9ElQK7/e\nb2Szxg4LeGK+TLcsFwQHIowkln43SVradCNFvTgc9El5J/Yl7pps+shuhWt6DqKS\nJfgn1QFbyoBu6NX5afdrjBTxD6Jy/imvyE1yuFbOgzR7cG/iTBEJQcj1eJuKCc1P\nqIZDmiQFyjG415gSgs3z4TeMjwKBgQC8ojtup8Pj3xnwRzM0Xwtj9eqGwXEcqeaJ\nti1RJMhqtztgT279IfTh1RqjdD7dVcu29irXOEGxjn2GmYnmkWJ00P2g2zrfPu2c\nsb+JR4ZofS1ZC58eO8cV+YDDqtvK9hIA8s6UwapIWCs8GUVs6TR55hvsUXwvaeYX\n/ZZuT78ttQKBgEOZt6WEIamnMQ4uTrkbp3LnOt56dL5KCC9ocggd+zGPSjMuDvWF\nC0a0f4td6mXoXBZluVcBWRf2vL1NWa6T6poItTDrBjuUppUI8q6dtmiELa/Dw2jy\nA7SWIC0x/5giPaCZV0xfQH6kJpsV96jFb4l4WIkeEEfu4/Rq4DjDyLUrAoGAdcVA\nH+0kU1/WXPrHEFqKzQUbQLkDeubkpXQVRQUXD/GIY7AUVnxd3KVlNUn9ecj4ICn/\nQ1G/SjDxVBkGTOrWMqLMxyI41mr+hQdA01/RnekRZ/fmh0TBHoohB4jkIwqQ4QC3\nU466VuKdU69fdgj/l1/AbUHOq/eNDctooUSu0sUCgYEAnAc8AYDZrlKoaBi7t0+v\nTXHbbB9x0j1TgzW1kyfKYp2T+FGpT8sMsvcvu75a6/tQY8m9xAJGJwY+C97DWLTR\nYuvA5PLt4WCoMRBpg5ibxdp7Z2/+xLbkRhuaTypa07B7+cdARcSiMVX/bFX82q6i\ngnKX4qEqQa2PeX1T5gHPDOU=\n-----END PRIVATE KEY-----\n",
  projectId: "talents-c856d"
};

const FIRESTORE_BATCH_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents:commit`;
const FIRESTORE_DOCS_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents/candidates`;
const FIRESTORE_RUN_QUERY_URL = `https://firestore.googleapis.com/v1/projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents:runQuery`;

// ID da Planilha de Dados (para importa√ß√£o hist√≥rica - opcional)
const SPREADSHEET_ID = "1DKJSelwLZkBag-1ORe-IXT2TVI0XpRpj-CIgR0oaIf0";

// ============================================================================
// GATILHO PRINCIPAL - EXECUTA QUANDO FORMUL√ÅRIO √â ENVIADO
// ============================================================================
/**
 * Fun√ß√£o acionada automaticamente quando um formul√°rio do Google Forms √© enviado
 * N√ÉO modifica a planilha - envia diretamente para o Firebase
 */
function onFormSubmit(e) {
  Logger.log("üîç DEBUG: onFormSubmit chamado");
  Logger.log(`   Tipo do evento: ${typeof e}`);
  Logger.log(`   Evento existe: ${!!e}`);
  
  if (e) {
    Logger.log(`   Propriedades do evento: ${Object.keys(e).join(', ')}`);
    Logger.log(`   e.namedValues existe: ${!!e.namedValues}`);
    Logger.log(`   e.values existe: ${!!e.values}`);
    Logger.log(`   e.range existe: ${!!e.range}`);
    Logger.log(`   e.response existe: ${!!e.response}`);
    Logger.log(`   e.source existe: ${!!e.source}`);
  }
  
  if (!e) {
    Logger.log("‚ö†Ô∏è  ERRO: Evento n√£o recebido (null ou undefined)");
    Logger.log("   Verifique se o gatilho est√° configurado corretamente.");
    return;
  }
  
  // Tenta obter dados do formul√°rio de diferentes formas
  var responses = null;
  
  // Formato 1: e.namedValues (formato tradicional do Forms)
  if (e.namedValues) {
    Logger.log("‚úÖ Usando formato e.namedValues");
    responses = e.namedValues;
  }
  // Formato 2: e.response (novo formato do Forms)
  else if (e.response) {
    Logger.log("‚úÖ Usando formato e.response");
    try {
      var formResponse = e.response;
      responses = {};
      var itemResponses = formResponse.getItemResponses();
      
      Logger.log(`   Total de respostas encontradas: ${itemResponses.length}`);
      
      for (var i = 0; i < itemResponses.length; i++) {
        try {
          var itemResponse = itemResponses[i];
          var item = itemResponse.getItem();
          var title = item.getTitle();
          var response = itemResponse.getResponse();
          
          // Converte resposta para array (formato esperado)
          if (Array.isArray(response)) {
            responses[title] = response;
          } else if (response !== null && response !== undefined) {
            responses[title] = [String(response)];
          } else {
            responses[title] = [""];
          }
          
          Logger.log(`   Campo ${i + 1}: "${title}" = ${responses[title].join(', ')}`);
        } catch (itemErr) {
          Logger.log(`   ‚ö†Ô∏è  Erro ao processar item ${i + 1}: ${itemErr.message}`);
        }
      }
      
      // Adiciona Carimbo de data/hora se n√£o estiver presente
      if (!responses['Carimbo de data/hora']) {
        try {
          var timestamp = formResponse.getTimestamp();
          responses['Carimbo de data/hora'] = [timestamp ? timestamp.toISOString() : new Date().toISOString()];
          Logger.log(`   Carimbo de data/hora adicionado: ${responses['Carimbo de data/hora'][0]}`);
        } catch (tsErr) {
          Logger.log(`   ‚ö†Ô∏è  Erro ao obter timestamp: ${tsErr.message}`);
          responses['Carimbo de data/hora'] = [new Date().toISOString()];
        }
      }
      
      Logger.log(`   ‚úÖ Total de campos extra√≠dos: ${Object.keys(responses).length}`);
    } catch (err) {
      Logger.log(`‚ùå Erro ao extrair dados de e.response: ${err.message}`);
      Logger.log(`   Stack: ${err.stack}`);
      Logger.log(`   Tipo de e.response: ${typeof e.response}`);
      if (e.response && e.response.toString) {
        Logger.log(`   e.response.toString(): ${e.response.toString()}`);
      }
      return;
    }
  }
  // Formato 3: e.source (se script est√° vinculado √† planilha)
  else if (e.source) {
    Logger.log("‚ö†Ô∏è  Script parece estar vinculado √† planilha, n√£o ao formul√°rio.");
    Logger.log("   Para funcionar corretamente, o script deve estar vinculado ao Google Forms.");
    Logger.log("   Solu√ß√£o:");
    Logger.log("   1. Abra o Google Forms");
    Logger.log("   2. Clique em Extens√µes ‚Üí Apps Script");
    Logger.log("   3. Cole o c√≥digo neste projeto vinculado ao Forms");
    Logger.log("   4. Configure o gatilho: onFormSubmit ‚Üí Do formul√°rio ‚Üí Ao enviar o formul√°rio");
    return;
  }
  else {
    Logger.log("‚ùå ERRO: Evento n√£o cont√©m namedValues, response nem source.");
    Logger.log("   Propriedades dispon√≠veis: " + Object.keys(e).join(', '));
    Logger.log("   Verifique se o gatilho est√° configurado corretamente:");
    Logger.log("   - Fun√ß√£o: onFormSubmit");
    Logger.log("   - Origem: Do formul√°rio (N√ÉO da planilha)");
    Logger.log("   - Tipo: Ao enviar o formul√°rio");
    return;
  }

  try {
    Logger.log("üìù Novo formul√°rio recebido - Processando...");
    Logger.log(`   Total de campos recebidos: ${Object.keys(responses).length}`);
    
    const candidato = mapearFormularioParaCandidato(responses);
    
    if (!candidato || !candidato.fullName) {
      Logger.log("‚ùå Erro: Dados do formul√°rio inv√°lidos ou nome n√£o encontrado.");
      Logger.log(`   Candidato mapeado: ${JSON.stringify(candidato)}`);
      return;
    }
    
    Logger.log(`‚úÖ Candidato mapeado: ${candidato.fullName}`);
    
    // Verifica se candidato j√° existe no Firebase (duplicata)
    if (candidato.email) {
      Logger.log(`üîç Verificando se candidato j√° existe (email: ${candidato.email})...`);
      const existe = verificarCandidatoExistente(candidato.email);
      
      if (existe) {
        Logger.log(`‚ö†Ô∏è  Candidato j√° existe no Firebase! ID: ${existe.docId}`);
        Logger.log(`   Nome existente: ${existe.fullName || 'N/A'}`);
        Logger.log(`   Email: ${existe.email}`);
        Logger.log(`   ‚è≠Ô∏è  Pulando envio para evitar duplicata.`);
        return;
      }
      Logger.log(`‚úÖ Candidato n√£o encontrado - pode enviar com seguran√ßa.`);
    } else {
      Logger.log(`‚ö†Ô∏è  Candidato sem email - enviando mesmo assim.`);
    }
    
    // Envia para o Firebase
    Logger.log(`üì§ Enviando candidato: ${candidato.fullName} (${candidato.email || 'sem email'})`);
    const resultado = enviarCandidatoParaFirebase(candidato);
    
    if (resultado.sucesso) {
      Logger.log(`‚úÖ Candidato enviado com sucesso! ID: ${resultado.docId}`);
      Logger.log(`   Status HTTP: ${resultado.statusCode}`);
    } else {
      Logger.log(`‚ùå Erro ao enviar candidato: ${resultado.erro}`);
      Logger.log(`   Status HTTP: ${resultado.statusCode || 'N/A'}`);
    }
    
  } catch (error) {
    Logger.log(`‚ùå Erro ao processar formul√°rio: ${error.message}`);
    Logger.log(`   Stack: ${error.stack}`);
  }
}

// ============================================================================
// MAPEAMENTO DE DADOS DO FORMUL√ÅRIO
// ============================================================================
/**
 * Mapeia os dados do Google Forms para o formato do Firebase
 */
function mapearFormularioParaCandidato(responses) {
  const candidato = {};
  
  // Helper para pegar valor do form de forma segura
  const get = (key) => {
    if (!responses[key]) return "";
    return Array.isArray(responses[key]) ? responses[key][0].trim() : String(responses[key]).trim();
  };
  
  // TIMESTAMPS - N√ÉO CONFUNDIR:
  // - original_timestamp = "Carimbo de data/hora" do Forms = quando a pessoa se inscreveu no formul√°rio.
  // - createdAt = quando o registro foi criado/gravado no Firebase (agora = execu√ß√£o deste script).
  const agora = new Date();
  const timestampOriginal = get('Carimbo de data/hora');
  
  let originalDate = agora;
  if (timestampOriginal) {
    try {
      originalDate = new Date(timestampOriginal);
      if (isNaN(originalDate.getTime())) originalDate = agora;
      // Se Carimbo vier no futuro (rel√≥gio do usu√°rio), limita a agora
      if (originalDate.getTime() > agora.getTime()) originalDate = agora;
    } catch (e) {
      originalDate = agora;
    }
  }
  
  // Formato Firestore: { timestampValue: "2024-01-19T10:30:00.000Z" }
  candidato.original_timestamp = { timestampValue: originalDate.toISOString() };
  candidato.createdAt = { timestampValue: agora.toISOString() };
  
  // Metadados adicionais
  candidato.origin = "forms_automation";
  candidato.createdBy = "Google Forms Automation";
  
  // Identifica√ß√£o e Contato
  candidato.fullName = get('Nome completo:');
  candidato.email = get('E-mail principal:') || get('Endere√ßo de e-mail');
  candidato.email_secondary = get('Endere√ßo de e-mail') || "";
  candidato.phone = get('N¬∫ telefone celular / Whatsapp:');
  
  // Dados Pessoais
  candidato.birthDate = formatarData(get('Data de Nascimento:'));
  candidato.age = parseInt(get('Idade')) || 0;
  candidato.photoUrl = get('Nos envie uma foto atual que voc√™ goste:');
  candidato.maritalStatus = get('Estado civil:') || "";
  candidato.childrenCount = parseInt(get('Se tem filhos, quantos?')) || 0;
  candidato.hasLicense = get('Voc√™ possui CNH tipo B?') || "";
  
  // Localiza√ß√£o (normalizada)
  const cidadeRaw = get('Cidade onde reside:');
  candidato.city = cidadeRaw ? normalizarCidade(cidadeRaw) : "";
  
  // Profissional e Acad√™mico
  candidato.education = get('Forma√ß√£o:');
  candidato.schoolingLevel = get('N√≠vel de escolaridade:');
  candidato.institution = get('Institui√ß√£o de ensino:');
  candidato.graduationDate = formatarData(get('Data de formatura:'));
  candidato.isStudying = get('Em caso de curso superior, est√° cursando neste momento?') || "";
  candidato.experience = get('Experi√™ncias anteriores:');
  candidato.courses = get('Cursos e certifica√ß√µes profissionais.') || "";
  candidato.certifications = get('Certifica√ß√µes profissionais:') || "";
  
  // √Åreas de interesse (normalizada)
  const areasRaw = get('√Åreas de interesse profissional');
  candidato.interestAreas = normalizeInterests(areasRaw);
  
  // Links
  candidato.cvUrl = get('Anexar curr√≠culo:');
  candidato.portfolioUrl = get('Portf√≥lio de trabalho:');
  
  // Processo e Fit Cultural
  candidato.source = normalizarSource(get('Onde voc√™ nos encontrou?') || "Google Forms");
  candidato.referral = get('Voc√™ foi indicado por algum colaborador da Young? Se sim, quem?') || "";
  candidato.salaryExpectation = get('Qual seria sua expectativa salarial?') || "";
  candidato.canRelocate = get('Teria disponibilidade para mudan√ßa de cidade?') || "";
  candidato.references = get('Refer√™ncias profissionais:') || "";
  candidato.typeOfApp = get('Voc√™ est√° se candidatando a uma vaga espec√≠fica ou apenas quer se inscrever no banco de talentos?') || get('Voc√™ est√° se candidatando a uma vaga espec√≠fica...?') || "";
  candidato.freeField = get('Campo Livre, SEJA VOC√ä!') || "";
  
  // Status do Pipeline
  candidato.status = "Inscrito";
  
  // Tags
  candidato.tags = ["Novo Inscrito"];
  
  // Metadados de origem e cria√ß√£o (j√° definidos acima, mas garantindo que est√£o corretos)
  // origin e createdBy j√° foram definidos acima na linha 120-121
  
  return candidato;
}

// ============================================================================
// VERIFICA√á√ÉO DE DUPLICATAS
// ============================================================================
/**
 * Verifica se um candidato j√° existe no Firebase consultando por email
 * Retorna dados do candidato se existir, null se n√£o existir
 */
function verificarCandidatoExistente(email) {
  if (!email || email.trim() === "") return null;
  
  try {
    const token = getServiceAccountToken();
    
    // Query Firestore para buscar por email
    // Nota: Isso requer um √≠ndice no Firestore se o email n√£o for √∫nico
    // Alternativa: usar o docId baseado em email + timestamp (mais eficiente)
    const query = {
      structuredQuery: {
        from: [{ collectionId: "candidates" }],
        where: {
          fieldFilter: {
            field: { fieldPath: "email" },
            op: "EQUAL",
            value: { stringValue: email.trim() }
          }
        },
        limit: 1
      }
    };
    
    const options = {
      method: "post",
      contentType: "application/json",
      headers: { 
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      },
      payload: JSON.stringify(query),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(FIRESTORE_RUN_QUERY_URL, options);
    const statusCode = response.getResponseCode();
    
    if (statusCode !== 200) {
      Logger.log(`  ‚ö†Ô∏è  Erro ao consultar Firebase: Status ${statusCode}`);
      return null;
    }
    
    const responseData = JSON.parse(response.getContentText());
    
    // Se encontrou resultados
    if (responseData && responseData.length > 0 && responseData[0].document) {
      const doc = responseData[0].document;
      const fields = doc.fields || {};
      
      // Extrai dados do documento
      const dados = {};
      for (const key in fields) {
        const field = fields[key];
        if (field.stringValue) dados[key] = field.stringValue;
        else if (field.integerValue) dados[key] = parseInt(field.integerValue);
        else if (field.booleanValue) dados[key] = field.booleanValue === true || field.booleanValue === 'true';
        else if (field.arrayValue) dados[key] = field.arrayValue.values.map(v => v.stringValue || v);
      }
      
      return {
        docId: doc.name.split('/').pop(),
        ...dados
      };
    }
    
    return null;
    
  } catch (error) {
    Logger.log(`  ‚ö†Ô∏è  Erro ao verificar duplicata: ${error.message}`);
    return null;
  }
}

// ============================================================================
// ENVIO PARA FIREBASE
// ============================================================================
/**
 * Envia um candidato para o Firebase Firestore
 * Usa ID √∫nico baseado em email + timestamp para evitar duplicatas
 */
function enviarCandidatoParaFirebase(candidato) {
  try {
    // Gera ID √∫nico baseado em email + timestamp para evitar duplicatas
    // Extrai string do timestamp para gerar ID √∫nico
    const timestampStr = candidato.original_timestamp?.timestampValue || candidato.createdAt?.timestampValue || new Date().toISOString();
    const uniqueString = (candidato.email || "sem_email") + "_" + timestampStr;
    const docId = Utilities.base64EncodeWebSafe(Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, uniqueString));
    
    // Converte dados para formato Firestore
    const fields = {};
    for (const key in candidato) {
      const value = candidato[key];
      if (value === null || value === undefined || value === "") continue;
      
      // Converte para tipo correto do Firestore
      if (key === 'original_timestamp' || key === 'createdAt') {
        // Timestamp do Firestore - j√° est√° no formato correto
        if (value.timestampValue) {
          fields[key] = { timestampValue: value.timestampValue };
        } else if (typeof value === 'string') {
          // Se ainda for string, converte
          fields[key] = { timestampValue: value };
        } else {
          fields[key] = { timestampValue: new Date().toISOString() };
        }
      } else if (Array.isArray(value)) {
        fields[key] = { 
          arrayValue: { 
            values: value.map(v => ({ stringValue: String(v) })) 
          } 
        };
      } else if (typeof value === 'number') {
        fields[key] = { integerValue: value };
      } else if (typeof value === 'boolean') {
        fields[key] = { booleanValue: value };
      } else if (typeof value === 'object' && value.timestampValue) {
        // Objeto timestamp j√° formatado
        fields[key] = { timestampValue: value.timestampValue };
      } else {
        fields[key] = { stringValue: String(value) };
      }
    }
    
    // Prepara opera√ß√£o de escrita (usando update para fazer upsert - criar ou atualizar)
    const docPath = `${FIRESTORE_DOCS_URL}/${docId}`;
    const payload = {
      fields: fields
    };
    
    const token = getServiceAccountToken();
    const options = {
      method: "patch",
      contentType: "application/json",
      headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    var response;
    var statusCode;
    var responseText;
    var lastError = null;
    var maxTentativas = 3;

    for (var tentativa = 1; tentativa <= maxTentativas; tentativa++) {
      try {
        response = UrlFetchApp.fetch(docPath, options);
        statusCode = response.getResponseCode();
        responseText = response.getContentText();

        if (statusCode === 200 || statusCode === 201) {
          return { sucesso: true, docId: docId, statusCode: statusCode };
        }

        // N√£o faz retry em erros 4xx (exceto 429)
        if (statusCode >= 400 && statusCode < 500 && statusCode !== 429) {
          break;
        }
        lastError = "HTTP " + statusCode + ": " + (responseText || "").substring(0, 300);
        if (tentativa < maxTentativas) {
          Logger.log("  ‚ö†Ô∏è  Tentativa " + tentativa + " falhou. Nova tentativa em 2s...");
          Utilities.sleep(2000);
        }
      } catch (e) {
        lastError = e.message || String(e);
        if (tentativa < maxTentativas) {
          Logger.log("  ‚ö†Ô∏è  Tentativa " + tentativa + " exce√ß√£o: " + lastError + ". Nova tentativa em 2s...");
          Utilities.sleep(2000);
        } else {
          return { sucesso: false, erro: "Exce√ß√£o ap√≥s " + maxTentativas + " tentativas: " + lastError };
        }
      }
    }

    // Mensagem de erro mais clara por tipo de status
    var msg = "Erro Firebase (" + statusCode + "): " + (responseText || "").substring(0, 200);
    if (statusCode === 403) msg += " Sugest√£o: verifique as permiss√µes do Service Account no projeto Firebase (Firebase Admin / Cloud Datastore User).";
    if (statusCode === 401) msg += " Sugest√£o: credenciais (FIREBASE_CONFIG.key ou .email) podem estar incorretas ou expiradas.";
    if (statusCode === 404) msg += " Sugest√£o: confira FIRESTORE_DOCS_URL e se a cole√ß√£o 'candidates' existe.";
    Logger.log("  ‚ö†Ô∏è  " + msg);
    return { sucesso: false, erro: msg, statusCode: statusCode };

  } catch (error) {
    var errMsg = error.message || String(error);
    Logger.log("  ‚ö†Ô∏è  Exce√ß√£o em enviarCandidatoParaFirebase: " + errMsg);
    if (error.stack) Logger.log("  Stack: " + (error.stack || "").substring(0, 500));
    return { sucesso: false, erro: "Exce√ß√£o: " + errMsg };
  }
}

// ============================================================================
// AUTENTICA√á√ÉO E TOKENS
// ============================================================================
function getServiceAccountToken() {
  const privateKey = FIREBASE_CONFIG.key.replace(/\\n/g, '\n');
  const clientEmail = FIREBASE_CONFIG.email;
  const header = { alg: "RS256", typ: "JWT" };
  const now = Math.floor(Date.now() / 1000);
  const claim = { 
    iss: clientEmail, 
    scope: "https://www.googleapis.com/auth/datastore", 
    aud: "https://oauth2.googleapis.com/token", 
    exp: now + 3600, 
    iat: now 
  };
  const toSign = Utilities.base64EncodeWebSafe(JSON.stringify(header)) + "." + Utilities.base64EncodeWebSafe(JSON.stringify(claim));
  const signature = Utilities.base64EncodeWebSafe(Utilities.computeRsaSha256Signature(toSign, privateKey));
  const jwt = toSign + "." + signature;
  const params = { 
    method: "post", 
    payload: { 
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer", 
      assertion: jwt 
    }, 
    muteHttpExceptions: true 
  };
  const response = UrlFetchApp.fetch("https://oauth2.googleapis.com/token", params);
  const json = JSON.parse(response.getContentText());
  if (json.error) throw new Error("Erro Token: " + json.error_description);
  return json.access_token;
}

// ============================================================================
// NORMALIZA√á√ÉO DE DADOS
// ============================================================================
function formatarData(valor) {
  if (!valor) return "";
  if (!isNaN(valor) && valor > 20000) { 
    // Formato serial do Excel/Sheets
    const date = new Date((valor - 25569) * 86400 * 1000);
    return date.toISOString().split('T')[0];
  }
  // Tenta parsear como data
  const date = new Date(valor);
  if (!isNaN(date.getTime())) {
    return date.toISOString().split('T')[0];
  }
  return String(valor).trim();
}

function normalizarCidade(city) {
  if (!city || typeof city !== 'string') return "";
  
  const normalized = city.trim();
  const lowerCity = normalized.toLowerCase();
  
  // Remove acentos para compara√ß√£o mais flex√≠vel
  const removeAccents = function(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  };
  
  const lowerCityNoAccents = removeAccents(lowerCity);
  
  // Cidades principais com suas varia√ß√µes
  const mainCities = {
    'Porto Alegre/RS': ['porto alegre', 'porto alegre/rs', 'poa', 'poa/rs', 'portoalegre', 'porto alegre rs', 'p. alegre', 'p. alegre/rs'],
    'Canoas/RS': ['canoas', 'canoas/rs', 'canoas rs'],
    'Bag√©/RS': ['bag√©', 'bage', 'bag√©/rs', 'bage/rs', 'bag√© rs', 'bage rs'],
    'Santo Ant√¥nio da Patrulha/RS': ['santo ant√¥nio da patrulha', 'santo antonio da patrulha', 'sto ant√¥nio da patrulha', 'sto antonio da patrulha', 'santo ant patrulha', 'sto ant patrulha', 'sap', 'sap/rs', 'sap rs', 'santo ant√¥nio da patrulha/rs', 'santo antonio da patrulha/rs', 'sto ant√¥nio da patrulha/rs', 'sto antonio da patrulha/rs', 'santo ant patrulha/rs', 'sto ant patrulha/rs'],
    'Gua√≠ba/RS': ['gua√≠ba', 'guaiba', 'gua√≠ba/rs', 'guaiba/rs', 'gua√≠ba rs', 'guaiba rs'],
    'Os√≥rio/RS': ['os√≥rio', 'osorio', 'os√≥rio/rs', 'osorio/rs', 'os√≥rio rs', 'osorio rs'],
    'Tramanda√≠/RS': ['tramanda√≠', 'tramandai', 'tramanda√≠/rs', 'tramandai/rs', 'tramanda√≠ rs', 'tramandai rs', 'tramandai/rs'],
    'S√£o Borja/RS': ['s√£o borja', 'sao borja', 's√£o borja/rs', 'sao borja/rs', 's√£o borja rs', 'sao borja rs', 's borja', 's borja/rs'],
    "Sant'Ana do Livramento/RS": ["sant'ana do livramento", "santana do livramento", "sant'ana do livramento/rs", "santana do livramento/rs", "sant'ana do livramento rs", "santana do livramento rs", "sant ana do livramento", "sant ana do livramento/rs", "livramento", "livramento/rs", "livramento rs"],
    'Cruz Alta/RS': ['cruz alta', 'cruz alta/rs', 'cruz alta rs', 'cruzalta', 'cruzalta/rs'],
    'Itaqui/RS': ['itaqui', 'itaqui/rs', 'itaqui rs'],
    'Alegrete/RS': ['alegrete', 'alegrete/rs', 'alegrete rs'],
    'Arroio do Sal/RS': ['arroio do sal', 'arroio do sal/rs', 'arroio do sal rs', 'arroio sal', 'arroio sal/rs', 'arroio sal rs'],
    'Torres/RS': ['torres', 'torres/rs', 'torres rs']
  };
  
  // Procura nas cidades principais
  for (const [standardName, variations] of Object.entries(mainCities)) {
    if (lowerCity === standardName.toLowerCase()) {
      return standardName;
    }
    
    for (let i = 0; i < variations.length; i++) {
      const variation = variations[i];
      const lowerVariation = variation.toLowerCase();
      const lowerVariationNoAccents = removeAccents(lowerVariation);
      
      if (lowerCity === lowerVariation || lowerCityNoAccents === lowerVariationNoAccents) {
        return standardName;
      }
      
      if (lowerCity.indexOf(lowerVariation) !== -1 || lowerVariation.indexOf(lowerCity) !== -1) {
        if (lowerVariation.length > 2 && lowerCity.length > 2) {
          return standardName;
        }
      }
    }
    
    const lowerStandard = standardName.toLowerCase();
    const lowerStandardNoAccents = removeAccents(lowerStandard);
    
    if (lowerCity.indexOf(lowerStandardNoAccents) !== -1 || lowerStandardNoAccents.indexOf(lowerCity) !== -1) {
      if (lowerStandard.length > 5 && lowerCity.length > 5) {
        return standardName;
      }
    }
  }
  
  // Se n√£o encontrou, padroniza formato b√°sico
  const words = normalized.split(/\s+/);
  const cleaned = words.map(function(word) {
    if (word.length === 0) return '';
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  
  // Adiciona /RS se n√£o tiver estado
  if (cleaned.indexOf('/') === -1 && !cleaned.match(/\b(RS|SC|PR|SP|RJ|MG|ES|BA|SE|AL|PE|PB|RN|CE|PI|MA|PA|AP|AM|AC|RO|RR|TO|GO|MT|MS|DF)\b/i)) {
    return cleaned + '/RS';
  }
  
  return cleaned;
}

function normalizeInterests(rawString) {
  if (!rawString) return "";
  // Converte array para string separada por v√≠rgula (compat√≠vel com frontend)
  if (Array.isArray(rawString)) {
    return rawString.join(', ');
  }
  // Se j√° for string, retorna como est√° (normalizada)
  return String(rawString).trim();
}

function normalizarSource(source) {
  if (!source) return "Google Forms";
  const normalized = String(source).trim().toLowerCase();
  
  // Normaliza varia√ß√µes comuns de origem
  const sources = {
    'google': 'Google',
    'google forms': 'Google Forms',
    'facebook': 'Facebook',
    'instagram': 'Instagram',
    'linkedin': 'LinkedIn',
    'indica√ß√£o': 'Indica√ß√£o',
    'indicacao': 'Indica√ß√£o',
    'site': 'Site',
    'outro': 'Outro'
  };
  
  for (const [key, value] of Object.entries(sources)) {
    if (normalized.includes(key)) {
      return value;
    }
  }
  
  // Retorna com primeira letra mai√∫scula
  return source.charAt(0).toUpperCase() + source.slice(1).toLowerCase();
}

// ============================================================================
// CONFIGURA√á√ÉO DE GATILHOS
// ============================================================================
/**
 * Configura gatilho autom√°tico no Google Forms
 * Execute esta fun√ß√£o UMA VEZ para configurar
 */
function setupTriggers() {
  // Remove TODOS os gatilhos existentes que chamam onFormSubmit (incluindo time-based)
  const triggers = ScriptApp.getProjectTriggers();
  let removidos = 0;
  
  triggers.forEach(function(trigger) {
    const handlerFunction = trigger.getHandlerFunction();
    const eventType = trigger.getEventType();
    
    // Remove qualquer gatilho que chame onFormSubmit, especialmente time-based
    if (handlerFunction === 'onFormSubmit') {
      Logger.log(`üóëÔ∏è  Removendo gatilho incorreto: ${handlerFunction} (Tipo: ${eventType})`);
      ScriptApp.deleteTrigger(trigger);
      removidos++;
    }
  });
  
  if (removidos > 0) {
    Logger.log(`‚úÖ ${removidos} gatilho(s) incorreto(s) removido(s).`);
  }
  
  // IMPORTANTE: O gatilho precisa ser criado no contexto do Formul√°rio
  // Se o script est√° vinculado ao Form, isso funcionar√°:
  try {
    const form = FormApp.getActiveForm();
    ScriptApp.newTrigger('onFormSubmit')
      .onFormSubmit()
      .create();
    
    Logger.log("‚úÖ Gatilho CORRETO configurado com sucesso!");
    Logger.log("   - Fun√ß√£o: onFormSubmit");
    Logger.log("   - Tipo: Evento de envio do formul√°rio");
    Logger.log("   - Executa automaticamente quando formul√°rio √© enviado");
    Logger.log("   - Cada novo envio ser√° enviado automaticamente para o Firebase");
  } catch (e) {
    Logger.log("‚ö†Ô∏è  ATEN√á√ÉO: N√£o foi poss√≠vel criar gatilho automaticamente.");
    Logger.log("   Instru√ß√µes manuais:");
    Logger.log("   1. No editor do Apps Script, v√° em: Editar ‚Üí Gatilhos do projeto atual");
    Logger.log("   2. Clique em 'Adicionar gatilho'");
    Logger.log("   3. Selecione:");
    Logger.log("      - Fun√ß√£o: onFormSubmit");
    Logger.log("      - Origem do evento: Do formul√°rio");
    Logger.log("      - Tipo de evento: Ao enviar o formul√°rio");
    Logger.log("   4. Salve");
    Logger.log(`   Erro: ${e.message}`);
  }
}

/**
 * Fun√ß√£o para listar TODOS os gatilhos configurados
 * √ötil para debug e verifica√ß√£o
 */
function listarTodosGatilhos() {
  const triggers = ScriptApp.getProjectTriggers();
  
  Logger.log("=".repeat(60));
  Logger.log("üìã LISTA DE TODOS OS GATILHOS CONFIGURADOS");
  Logger.log("=".repeat(60));
  
  if (triggers.length === 0) {
    Logger.log("‚ö†Ô∏è  Nenhum gatilho configurado.");
    return;
  }
  
  triggers.forEach(function(trigger, index) {
    const handlerFunction = trigger.getHandlerFunction();
    const eventType = trigger.getEventType();
    const uniqueId = trigger.getUniqueId();
    
    Logger.log(`\n${index + 1}. Gatilho ID: ${uniqueId}`);
    Logger.log(`   Fun√ß√£o: ${handlerFunction}`);
    Logger.log(`   Tipo de evento: ${eventType}`);
    
    // Informa√ß√µes espec√≠ficas por tipo
    if (eventType === ScriptApp.EventType.ON_FORM_SUBMIT) {
      Logger.log(`   ‚úÖ CORRETO: Gatilho de envio de formul√°rio`);
    } else if (eventType === ScriptApp.EventType.CLOCK) {
      Logger.log(`   ‚ö†Ô∏è  ATEN√á√ÉO: Gatilho baseado em tempo`);
      try {
        const source = trigger.getTriggerSource();
        Logger.log(`   Origem: ${source}`);
      } catch (e) {
        Logger.log(`   Origem: N√£o dispon√≠vel`);
      }
    } else {
      Logger.log(`   Tipo: ${eventType}`);
    }
  });
  
  Logger.log("\n" + "=".repeat(60));
  Logger.log(`Total: ${triggers.length} gatilho(s) configurado(s)`);
  Logger.log("=".repeat(60));
  
  // Verifica se h√° problemas
  const formSubmitTriggers = triggers.filter(t => 
    t.getHandlerFunction() === 'onFormSubmit' && t.getEventType() === ScriptApp.EventType.ON_FORM_SUBMIT
  );
  const timeBasedTriggers = triggers.filter(t => 
    t.getHandlerFunction() === 'onFormSubmit' && t.getEventType() === ScriptApp.EventType.CLOCK
  );
  
  if (timeBasedTriggers.length > 0) {
    Logger.log("\n‚ö†Ô∏è  PROBLEMA ENCONTRADO:");
    Logger.log(`   H√° ${timeBasedTriggers.length} gatilho(s) time-based chamando onFormSubmit`);
    Logger.log("   Execute limparGatilhosIncorretos() para remover.");
  }
  
  if (formSubmitTriggers.length === 0) {
    Logger.log("\n‚ö†Ô∏è  PROBLEMA ENCONTRADO:");
    Logger.log("   Nenhum gatilho correto (ON_FORM_SUBMIT) configurado!");
    Logger.log("   Execute setupTriggers() para configurar.");
  } else if (formSubmitTriggers.length === 1) {
    Logger.log("\n‚úÖ Configura√ß√£o correta:");
    Logger.log("   H√° 1 gatilho correto configurado.");
  } else {
    Logger.log("\n‚ö†Ô∏è  ATEN√á√ÉO:");
    Logger.log(`   H√° ${formSubmitTriggers.length} gatilhos ON_FORM_SUBMIT configurados.`);
    Logger.log("   Pode haver duplicatas. Considere executar setupTriggers() para limpar.");
  }
}

/**
 * Fun√ß√£o para limpar gatilhos incorretos manualmente
 * Execute esta fun√ß√£o se houver gatilhos time-based chamando onFormSubmit
 */
function limparGatilhosIncorretos() {
  const triggers = ScriptApp.getProjectTriggers();
  let removidos = 0;
  
  Logger.log("üîç Verificando gatilhos existentes...");
  
  triggers.forEach(function(trigger) {
    const handlerFunction = trigger.getHandlerFunction();
    const eventType = trigger.getEventType();
    
    Logger.log(`   - Fun√ß√£o: ${handlerFunction}, Tipo: ${eventType}`);
    
    // Remove qualquer gatilho time-based que chame onFormSubmit
    if (handlerFunction === 'onFormSubmit' && eventType === ScriptApp.EventType.CLOCK) {
      Logger.log(`   ‚ùå Gatilho INCORRETO encontrado (time-based chamando onFormSubmit) - Removendo...`);
      ScriptApp.deleteTrigger(trigger);
      removidos++;
    }
  });
  
  if (removidos > 0) {
    Logger.log(`‚úÖ ${removidos} gatilho(s) incorreto(s) removido(s).`);
    Logger.log("   Agora execute setupTriggers() para configurar o gatilho correto.");
  } else {
    Logger.log("‚úÖ Nenhum gatilho incorreto encontrado.");
  }
}

// ============================================================================
// IMPORTA√á√ÉO EM MASSA (PARA HIST√ìRICO DA PLANILHA - OPCIONAL)
// ============================================================================
/**
 * Importa dados hist√≥ricos da planilha do Google Sheets em lotes
 * √ötil para importar dados antigos que j√° estavam na planilha
 * IMPORTANTE: S√≥ funciona se voc√™ tiver acesso √† planilha vinculada
 */
function importarEmLotes() {
  try {
    const BATCH_SIZE = 400; // Limite seguro por requisi√ß√£o

    // Abre a planilha pelo ID espec√≠fico
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheets()[0];
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1); // Remove cabe√ßalho

    Logger.log(`üìä Iniciando importa√ß√£o hist√≥rica de ${rows.length} linhas da planilha...`);

    let totalEnviado = 0;
    let totalErros = 0;
    let totalIgnorados = 0; // Linhas vazias ou inv√°lidas
    const totalLotes = Math.ceil(rows.length / BATCH_SIZE);

    // Loop principal: Processa em blocos de 400
    for (let i = 0; i < rows.length; i += BATCH_SIZE) {
      const loteNum = Math.floor(i / BATCH_SIZE) + 1;
      const chunk = rows.slice(i, i + BATCH_SIZE);
      const writes = [];
      const inicioLote = new Date();

      Logger.log(`‚è≥ Processando lote ${loteNum}/${totalLotes} (linhas ${i + 1} a ${Math.min(i + BATCH_SIZE, rows.length)})...`);
      Logger.log(`   üìã Preparando ${chunk.length} registros para envio...`);

      chunk.forEach((row, index) => {
        // Pula linhas vazias se houver
        if (!row[0] && !row[2]) return;

        const candidato = rowToCandidateObject(row, headers);
        
        if (!candidato || !candidato.fullName) return;
        
        // NOTA: Removida verifica√ß√£o de duplicata durante importa√ß√£o em massa
        // O Firebase faz upsert automaticamente (cria ou atualiza) com base no docId √∫nico
        // Isso torna a importa√ß√£o muito mais r√°pida
        
        // Gera ID √∫nico para o documento (baseado em email + timestamp)
        const timestampStr = candidato.original_timestamp?.timestampValue || candidato.createdAt?.timestampValue || new Date().toISOString();
        const uniqueString = (candidato.email || "sem_email") + "_" + timestampStr;
        const docId = Utilities.base64EncodeWebSafe(Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, uniqueString));
        
        // Converte para formato Firestore
        const fields = {};
        for (const key in candidato) {
          const value = candidato[key];
          if (value === null || value === undefined || value === "") continue;
          
          // Trata timestamps do Firestore
          if (key === 'original_timestamp' || key === 'createdAt') {
            if (value.timestampValue) {
              fields[key] = { timestampValue: value.timestampValue };
            } else if (typeof value === 'string') {
              fields[key] = { timestampValue: value };
            } else {
              fields[key] = { timestampValue: new Date().toISOString() };
            }
          } else if (Array.isArray(value)) {
            fields[key] = { arrayValue: { values: value.map(v => ({ stringValue: String(v) })) } };
          } else if (typeof value === 'number') {
            fields[key] = { integerValue: value };
          } else if (typeof value === 'boolean') {
            fields[key] = { booleanValue: value };
          } else if (typeof value === 'object' && value.timestampValue) {
            fields[key] = { timestampValue: value.timestampValue };
          } else {
            fields[key] = { stringValue: String(value) };
          }
        }

        const docPath = `projects/${FIREBASE_CONFIG.projectId}/databases/(default)/documents/candidates/${docId}`;

        writes.push({
          update: {
            name: docPath,
            fields: fields
          }
        });
      });

      Logger.log(`   üì¶ ${writes.length} documento(s) preparado(s) para envio...`);

      if (writes.length > 0) {
        try {
          Logger.log(`   üöÄ Enviando lote ${loteNum} para Firebase...`);
          enviarBatchFirestore(writes);
          totalEnviado += writes.length;
          const tempoLote = ((new Date() - inicioLote) / 1000).toFixed(2);
          Logger.log(`  ‚úÖ Lote ${loteNum} enviado com sucesso! (${writes.length} registro(s) em ${tempoLote}s)`);
        } catch (e) {
          totalErros += writes.length;
          Logger.log(`  ‚ùå Erro ao enviar lote ${loteNum}: ${e.message}`);
          Logger.log(`     Stack: ${e.stack}`);
        }
      } else {
        totalIgnorados += chunk.length;
        Logger.log(`  ‚ö†Ô∏è  Lote ${loteNum} vazio - nenhum registro v√°lido encontrado.`);
      }
      
      // Pausa para evitar limite de taxa (apenas entre lotes, n√£o no √∫ltimo)
      if (loteNum < totalLotes) {
        Logger.log(`   ‚è∏Ô∏è  Pausa de 1 segundo antes do pr√≥ximo lote...`);
        Utilities.sleep(1000);
      }
    }
    
    // Resumo final
    Logger.log("=".repeat(50));
    Logger.log(`üìà RESUMO DA IMPORTA√á√ÉO HIST√ìRICA:`);
    Logger.log(`  ‚úÖ Total enviado para Firebase: ${totalEnviado}`);
    Logger.log(`  ‚ö†Ô∏è  Total ignorados (vazios/inv√°lidos): ${totalIgnorados}`);
    Logger.log(`  ‚ùå Total com erro: ${totalErros}`);
    Logger.log(`  üìä Total processado: ${totalEnviado + totalIgnorados + totalErros} de ${rows.length}`);
    Logger.log(`  üì¶ Total de lotes processados: ${totalLotes}`);
    Logger.log("=".repeat(50));
    Logger.log(`‚úÖ Importa√ß√£o conclu√≠da! Verifique o Firebase para confirmar os dados.`);
    
  } catch (e) {
    Logger.log(`‚ùå Erro na importa√ß√£o em lotes: ${e.message}`);
    Logger.log(`   Stack: ${e.stack}`);
  }
}

/**
 * Mapeia uma linha da planilha para objeto candidato
 */
function rowToCandidateObject(row, headers) {
  const get = (headerName) => {
    const index = headers.indexOf(headerName);
    return (index > -1 && row[index]) ? String(row[index]).trim() : "";
  };

  // original_timestamp = Carimbo da planilha (quando a pessoa se inscreveu). createdAt = quando o registro foi importado (agora).
  const agora = new Date();
  const timestampOriginal = get('Carimbo de data/hora');
  let originalDate = agora;
  if (timestampOriginal) {
    try {
      originalDate = new Date(timestampOriginal);
      if (isNaN(originalDate.getTime())) originalDate = agora;
      if (originalDate.getTime() > agora.getTime()) originalDate = agora; // evita data futura
    } catch (e) { originalDate = agora; }
  }
  
  const candidato = {
    external_id: get('COD') || "",
    createdAt: { timestampValue: agora.toISOString() },
    original_timestamp: { timestampValue: originalDate.toISOString() },
    origin: "batch_script",
    createdBy: "Batch Import Script",
    
    // Identifica√ß√£o e Contato
    fullName: get('Nome completo:'),
    email: get('E-mail principal:') || get('Endere√ßo de e-mail'),
    email_secondary: get('Endere√ßo de e-mail') || "",
    phone: get('N¬∫ telefone celular / Whatsapp:'),
    
    // Dados Pessoais
    birthDate: formatarData(get('Data de Nascimento:')),
    age: parseInt(get('Idade')) || 0,
    photoUrl: get('Nos envie uma foto atual que voc√™ goste:'),
    maritalStatus: get('Estado civil:') || "",
    childrenCount: parseInt(get('Se tem filhos, quantos?')) || 0,
    hasLicense: get('Voc√™ possui CNH tipo B?') || "",
    
    // Localiza√ß√£o
    city: normalizarCidade(get('Cidade onde reside:')),
    
    // Profissional e Acad√™mico
    education: get('Forma√ß√£o:'),
    schoolingLevel: get('N√≠vel de escolaridade:'),
    institution: get('Institui√ß√£o de ensino:'),
    graduationDate: formatarData(get('Data de formatura:')),
    isStudying: get('Em caso de curso superior, est√° cursando neste momento?') || "",
    experience: get('Experi√™ncias anteriores:'),
    courses: get('Cursos e certifica√ß√µes profissionais.') || "",
    certifications: get('Certifica√ß√µes profissionais:') || "",
    interestAreas: normalizeInterests(get('√Åreas de interesse profissional')),
    
    // Links
    cvUrl: get('Anexar curr√≠culo:'),
    portfolioUrl: get('Portf√≥lio de trabalho:'),
    
    // Processo e Fit Cultural
    source: normalizarSource(get('Onde voc√™ nos encontrou?') || "Legado"),
    referral: get('Voc√™ foi indicado por algum colaborador da Young? Se sim, quem?') || "",
    salaryExpectation: get('Qual seria sua expectativa salarial?') || "",
    canRelocate: get('Teria disponibilidade para mudan√ßa de cidade?') || "",
    references: get('Refer√™ncias profissionais:') || "",
    typeOfApp: get('Voc√™ est√° se candidatando a uma vaga espec√≠fica ou apenas quer se inscrever no banco de talentos?') || get('Voc√™ est√° se candidatando a uma vaga espec√≠fica...?') || "",
    freeField: get('Campo Livre, SEJA VOC√ä!') || "",
    
    // Status do Pipeline
    status: "Inscrito",
    
    // Tags
    tags: ["Importado CSV"],
    
    // Metadados de origem e cria√ß√£o
    origin: "batch_script", // Origem: script de importa√ß√£o em lote (appscript)
    createdBy: "system", // Sistema (script)
    responsibleUser: "", // Vazio para importa√ß√£o em lote
    imported: true
  };

  return candidato;
}

/**
 * Envia lote de opera√ß√µes para o Firebase (para importa√ß√£o em massa)
 */
function enviarBatchFirestore(writesArray) {
  const token = getServiceAccountToken();
  const payload = { writes: writesArray };
  const options = {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: "Bearer " + token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(FIRESTORE_BATCH_URL, options);
  const statusCode = response.getResponseCode();
  
  if (statusCode !== 200) {
    const errorText = response.getContentText();
    Logger.log(`  ‚ö†Ô∏è  Resposta do Firebase: Status ${statusCode}`);
    Logger.log(`  ‚ö†Ô∏è  Erro: ${errorText}`);
    throw new Error(`Erro Firebase (${statusCode}): ${errorText}`);
  }
}

// ============================================================================
// FUN√á√ÉO DE TESTE
// ============================================================================
/**
 * Fun√ß√£o para testar o envio manualmente
 * Simula o envio de um formul√°rio completo
 * Esta fun√ß√£o cria um evento simulado igual ao que o Google Forms envia
 */
function testeEnvio() {
  try {
    Logger.log("üß™ TESTE: Simulando envio de formul√°rio completo...");
    
    // Cria um evento simulado igual ao que o Google Forms envia
    // O evento do Google Forms tem a estrutura: { namedValues: {...}, values: [...], range: {...} }
    const eventoSimulado = {
      namedValues: {
        'Carimbo de data/hora': [new Date().toISOString()],
        'Nome completo:': ['Jo√£o Silva Teste'],
        'E-mail principal:': ['teste.' + Date.now() + '@exemplo.com'], // Email √∫nico para evitar duplicatas
        'Endere√ßo de e-mail': ['teste.' + Date.now() + '@exemplo.com'],
        'N¬∫ telefone celular / Whatsapp:': ['(51) 99999-9999'],
        'Data de Nascimento:': ['15/03/1995'],
        'Idade': ['29'],
        'Nos envie uma foto atual que voc√™ goste:': ['https://exemplo.com/foto.jpg'],
        'Estado civil:': ['Solteiro'],
        'Se tem filhos, quantos?': ['0'],
        'Voc√™ possui CNH tipo B?': ['Sim'],
        'Cidade onde reside:': ['porto alegre'],
        'Forma√ß√£o:': ['Engenharia de Software'],
        'N√≠vel de escolaridade:': ['Superior Completo'],
        'Institui√ß√£o de ensino:': ['Universidade Federal do Rio Grande do Sul'],
        'Data de formatura:': ['15/12/2020'],
        'Em caso de curso superior, est√° cursando neste momento?': ['N√£o'],
        'Experi√™ncias anteriores:': ['Desenvolvedor Full Stack na Empresa XYZ por 3 anos. Trabalhei com React, Node.js e Firebase.'],
        'Cursos e certifica√ß√µes profissionais.': ['Certifica√ß√£o AWS Cloud Practitioner, Curso de React Avan√ßado'],
        'Certifica√ß√µes profissionais:': ['AWS Certified Cloud Practitioner'],
        '√Åreas de interesse profissional': ['Desenvolvimento Web, Cloud Computing, DevOps'],
        'Anexar curr√≠culo:': ['https://exemplo.com/curriculo.pdf'],
        'Portf√≥lio de trabalho:': ['https://github.com/joaosilva'],
        'Onde voc√™ nos encontrou?': ['LinkedIn'],
        'Voc√™ foi indicado por algum colaborador da Young? Se sim, quem?': ['N√£o'],
        'Qual seria sua expectativa salarial?': ['R$ 8.000,00'],
        'Teria disponibilidade para mudan√ßa de cidade?': ['Sim'],
        'Refer√™ncias profissionais:': ['Maria Santos - Gerente de Projetos - maria@empresa.com'],
        'Voc√™ est√° se candidatando a uma vaga espec√≠fica...?': ['N√£o, quero fazer parte do banco de talentos'],
        'Campo Livre, SEJA VOC√ä!': ['Sou apaixonado por tecnologia e sempre busco aprender coisas novas. Adoro trabalhar em equipe e contribuir para projetos desafiadores.']
      },
      values: [
        new Date().toISOString(), // Timestamp
        'Jo√£o Silva Teste',
        'teste.' + Date.now() + '@exemplo.com',
        '(51) 99999-9999',
        '15/03/1995',
        '29',
        'https://exemplo.com/foto.jpg',
        'Solteiro',
        '0',
        'Sim',
        'porto alegre',
        'Engenharia de Software',
        'Superior Completo',
        'Universidade Federal do Rio Grande do Sul',
        '15/12/2020',
        'N√£o',
        'Desenvolvedor Full Stack na Empresa XYZ por 3 anos.',
        'Certifica√ß√£o AWS Cloud Practitioner',
        'AWS Certified Cloud Practitioner',
        'Desenvolvimento Web, Cloud Computing',
        'https://exemplo.com/curriculo.pdf',
        'https://github.com/joaosilva',
        'LinkedIn',
        'N√£o',
        'R$ 8.000,00',
        'Sim',
        'Maria Santos - maria@empresa.com',
        'N√£o, quero fazer parte do banco de talentos',
        'Sou apaixonado por tecnologia...'
      ],
      range: {
        getRow: function() { return 2; },
        getColumn: function() { return 1; },
        getSheet: function() { return null; }
      }
    };
    
    Logger.log("üìù Evento simulado criado com sucesso!");
    Logger.log(`   Total de campos: ${Object.keys(eventoSimulado.namedValues).length}`);
    
    // Chama a fun√ß√£o onFormSubmit com o evento simulado
    Logger.log("\n" + "=".repeat(60));
    Logger.log("üöÄ Chamando onFormSubmit com evento simulado...");
    Logger.log("=".repeat(60) + "\n");
    
    onFormSubmit(eventoSimulado);
    
    Logger.log("\n" + "=".repeat(60));
    Logger.log("‚úÖ TESTE CONCLU√çDO");
    Logger.log("=".repeat(60));
    
  } catch (e) {
    Logger.log("\n" + "=".repeat(60));
    Logger.log("‚ùå ERRO NO TESTE");
    Logger.log("=".repeat(60));
    Logger.log("Erro: " + e.message);
    Logger.log("Stack: " + e.stack);
  }
}

/**
 * Fun√ß√£o de teste simplificada (vers√£o antiga mantida para compatibilidade)
 * Simula apenas alguns campos b√°sicos
 */
function testeEnvioSimples() {
  try {
    // Simula dados de um formul√°rio
    const testResponses = {
      'Carimbo de data/hora': [new Date().toISOString()],
      'Nome completo:': ['Teste Candidato'],
      'E-mail principal:': ['teste@exemplo.com'],
      'N¬∫ telefone celular / Whatsapp:': ['(51) 99999-9999'],
      'Cidade onde reside:': ['porto alegre'],
      'Experi√™ncias anteriores:': ['Teste de experi√™ncia profissional']
    };
    
    const candidato = mapearFormularioParaCandidato(testResponses);
    Logger.log("üìù Dados mapeados:");
    Logger.log(JSON.stringify(candidato, null, 2));
    
    // Testa verifica√ß√£o de duplicata
    if (candidato.email) {
      Logger.log(`üîç Verificando se j√° existe: ${candidato.email}`);
      const existe = verificarCandidatoExistente(candidato.email);
      if (existe) {
        Logger.log(`‚ö†Ô∏è  J√° existe! ID: ${existe.docId}`);
        return;
      }
    }
    
    const resultado = enviarCandidatoParaFirebase(candidato);
    
    if (resultado.sucesso) {
      Logger.log("‚úÖ Teste enviado com sucesso!");
      Logger.log(`   ID do documento: ${resultado.docId}`);
    } else {
      Logger.log("‚ùå Erro no teste:");
      Logger.log(`   ${resultado.erro}`);
    }
    
  } catch (e) {
    Logger.log("‚ùå Erro no teste: " + e.message);
    Logger.log("Stack: " + e.stack);
  }
}

// ============================================================================
// DIAGN√ìSTICO DO SISTEMA
// ============================================================================
/**
 * Executa diagn√≥stico completo do sistema: gatilhos, Firebase e credenciais.
 * Execute esta fun√ß√£o para identificar onde est√° falhando a integra√ß√£o.
 */
function diagnosticarSistema() {
  Logger.log("=".repeat(70));
  Logger.log("üîß DIAGN√ìSTICO DO SISTEMA - Forms ‚Üí AppScript ‚Üí Firebase");
  Logger.log("=".repeat(70));
  Logger.log("");

  // 1. Verifica√ß√£o de gatilhos
  Logger.log("üìã 1. GATILHOS CONFIGURADOS");
  Logger.log("-".repeat(50));
  const triggers = ScriptApp.getProjectTriggers();
  const formSubmitTriggers = triggers.filter(function(t) {
    return t.getHandlerFunction() === 'onFormSubmit' && t.getEventType() === ScriptApp.EventType.ON_FORM_SUBMIT;
  });
  const timeBasedTriggers = triggers.filter(function(t) {
    return t.getHandlerFunction() === 'onFormSubmit' && t.getEventType() === ScriptApp.EventType.CLOCK;
  });

  if (triggers.length === 0) {
    Logger.log("‚ùå Nenhum gatilho configurado. Execute setupTriggers() para configurar.");
  } else {
    triggers.forEach(function(t, i) {
      Logger.log("   " + (i+1) + ". " + t.getHandlerFunction() + " | Tipo: " + t.getEventType());
    });
    if (formSubmitTriggers.length === 0) {
      Logger.log("‚ùå Nenhum gatilho ON_FORM_SUBMIT. O acionador do Forms n√£o est√° correto.");
      if (timeBasedTriggers.length > 0) {
        Logger.log("   ‚ö†Ô∏è  H√° gatilhos time-based chamando onFormSubmit (incorreto). Execute limparGatilhosIncorretos() e setupTriggers().");
      }
    } else {
      Logger.log("‚úÖ Gatilho ON_FORM_SUBMIT encontrado: " + formSubmitTriggers.length);
    }
  }
  Logger.log("");

  // 2. Verifica√ß√£o de credenciais Firebase
  Logger.log("üîë 2. CREDENCIAIS FIREBASE (Service Account)");
  Logger.log("-".repeat(50));
  var configOk = true;
  if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.email) {
    Logger.log("‚ùå FIREBASE_CONFIG.email n√£o configurado");
    configOk = false;
  } else {
    Logger.log("   Email: " + FIREBASE_CONFIG.email);
  }
  if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.key || FIREBASE_CONFIG.key.length < 100) {
    Logger.log("‚ùå FIREBASE_CONFIG.key inv√°lido ou ausente");
    configOk = false;
  } else {
    Logger.log("   Chave privada: " + (FIREBASE_CONFIG.key.indexOf("-----BEGIN") === 0 ? "‚úÖ Presente" : "‚ùå Formato inv√°lido"));
  }
  if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.projectId) {
    Logger.log("‚ùå FIREBASE_CONFIG.projectId n√£o configurado");
    configOk = false;
  } else {
    Logger.log("   Project ID: " + FIREBASE_CONFIG.projectId);
  }
  if (configOk) Logger.log("‚úÖ Configura√ß√£o do Firebase OK");
  Logger.log("");

  // 3. Teste de token (autentica√ß√£o)
  Logger.log("üîê 3. TESTE DE AUTENTICA√á√ÉO (Token OAuth)");
  Logger.log("-".repeat(50));
  try {
    const token = getServiceAccountToken();
    if (token && token.length > 50) {
      Logger.log("‚úÖ Token obtido com sucesso (length: " + token.length + ")");
    } else {
      Logger.log("‚ùå Token vazio ou inv√°lido");
    }
  } catch (e) {
    Logger.log("‚ùå Erro ao obter token: " + e.message);
    Logger.log("   Stack: " + (e.stack || ""));
  }
  Logger.log("");

  // 4. Teste de conex√£o com Firestore (leitura)
  Logger.log("üì° 4. TESTE DE CONEX√ÉO COM FIRESTORE");
  Logger.log("-".repeat(50));
  try {
    const token = getServiceAccountToken();
    const query = {
      structuredQuery: {
        from: [{ collectionId: "candidates" }],
        limit: 1
      }
    };
    const options = {
      method: "post",
      contentType: "application/json",
      headers: { Authorization: "Bearer " + token, "Content-Type": "application/json" },
      payload: JSON.stringify(query),
      muteHttpExceptions: true
    };
    const response = UrlFetchApp.fetch(FIRESTORE_RUN_QUERY_URL, options);
    const statusCode = response.getResponseCode();
    if (statusCode === 200) {
      const data = JSON.parse(response.getContentText());
      Logger.log("‚úÖ Conex√£o Firestore OK (status " + statusCode + ")");
      if (data && data[0] && data[0].document) {
        Logger.log("   Exemplo doc em candidates: " + (data[0].document.name || "").split("/").pop());
      } else {
        Logger.log("   (Cole√ß√£o candidates vazia ou sem documentos)");
      }
    } else {
      Logger.log("‚ùå Firestore retornou status " + statusCode + ": " + response.getContentText().substring(0, 200));
    }
  } catch (e) {
    Logger.log("‚ùå Erro ao conectar Firestore: " + e.message);
    Logger.log("   Stack: " + (e.stack || ""));
  }
  Logger.log("");

  // 5. Verifica√ß√£o de Form/Planilha vinculada
  Logger.log("üìÑ 5. FORMUL√ÅRIO / PLANILHA VINCULADA");
  Logger.log("-".repeat(50));
  try {
    const form = FormApp.getActiveForm();
    Logger.log("‚úÖ Formul√°rio ativo: " + form.getTitle());
    Logger.log("   ID: " + form.getId());
  } catch (e) {
    Logger.log("‚ö†Ô∏è  " + e.message + " (script pode estar vinculado √† planilha de respostas)");
  }
  Logger.log("");

  Logger.log("=".repeat(70));
  Logger.log("üìå RESUMO: Execute listarTodosGatilhos() para detalhes dos gatilhos.");
  Logger.log("   Execute testeEnvio() para simular um envio completo.");
  Logger.log("=".repeat(70));
}

/**
 * Mapeamento esperado: r√≥tulo do Forms (exatamente como em e.namedValues) -> campo Firebase.
 * Deve estar alinhado com mapearFormularioParaCandidato e rowToCandidateObject.
 */
var FORM_TO_FIREBASE = {
  'Carimbo de data/hora': 'original_timestamp', // Campo autom√°tico do Forms (sempre presente)
  'Nome completo:': 'fullName',
  'E-mail principal:': 'email',
  'Endere√ßo de e-mail': 'email_secondary', // Pode n√£o existir se s√≥ houver "E-mail principal:"
  'N¬∫ telefone celular / Whatsapp:': 'phone',
  'Data de Nascimento:': 'birthDate',
  'Idade': 'age', // Pode n√£o existir no formul√°rio
  'Nos envie uma foto atual que voc√™ goste:': 'photoUrl',
  'Estado civil:': 'maritalStatus',
  'Se tem filhos, quantos?': 'childrenCount',
  'Voc√™ possui CNH tipo B?': 'hasLicense',
  'Cidade onde reside:': 'city',
  'Forma√ß√£o:': 'education',
  'N√≠vel de escolaridade:': 'schoolingLevel',
  'Institui√ß√£o de ensino:': 'institution',
  'Data de formatura:': 'graduationDate',
  'Em caso de curso superior, est√° cursando neste momento?': 'isStudying',
  'Experi√™ncias anteriores:': 'experience',
  'Cursos e certifica√ß√µes profissionais.': 'courses',
  'Certifica√ß√µes profissionais:': 'certifications', // Pode ter nome diferente no Form
  '√Åreas de interesse profissional': 'interestAreas',
  'Anexar curr√≠culo:': 'cvUrl', // Pode ter nome diferente no Form
  'Portf√≥lio de trabalho:': 'portfolioUrl',
  'Onde voc√™ nos encontrou?': 'source',
  'Voc√™ foi indicado por algum colaborador da Young? Se sim, quem?': 'referral',
  'Qual seria sua expectativa salarial?': 'salaryExpectation',
  'Teria disponibilidade para mudan√ßa de cidade?': 'canRelocate',
  'Refer√™ncias profissionais:': 'references',
  'Voc√™ est√° se candidatando a uma vaga espec√≠fica...?': 'typeOfApp', // Pode ter nome diferente no Form
  'Voc√™ est√° se candidatando a uma vaga espec√≠fica ou apenas quer se inscrever no banco de talentos?': 'typeOfApp', // Nome alternativo encontrado no Form
  'Campo Livre, SEJA VOC√ä!': 'freeField'
};

/**
 * Valida o mapeamento Forms -> Firebase.
 * Compara os campos que o script espera (FORM_TO_FIREBASE) com os itens do formul√°rio ativo (se dispon√≠vel).
 * Identifica: campos do Form n√£o mapeados; campos mapeados que n√£o existem no Form.
 */
function validarMapeamentoCampos() {
  Logger.log("=".repeat(60));
  Logger.log("üìã VALIDA√á√ÉO DE MAPEAMENTO: Forms -> Firebase");
  Logger.log("=".repeat(60));

  var formLabels = Object.keys(FORM_TO_FIREBASE);
  var firebaseKeys = [];
  for (var i = 0; i < formLabels.length; i++) {
    var k = FORM_TO_FIREBASE[formLabels[i]];
    if (firebaseKeys.indexOf(k) === -1) firebaseKeys.push(k);
  }

  Logger.log("Campos que o script mapeia (Forms -> Firebase): " + formLabels.length);
  Logger.log("Campos Firebase √∫nicos: " + firebaseKeys.length);

  var noForm = [];
  var formTitles = [];
  var sectionHeaders = []; // T√≠tulos de se√ß√£o (n√£o s√£o campos de dados)
  try {
    var form = FormApp.getActiveForm();
    var items = form.getItems();
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var t = item.getTitle();
      var itemType = item.getType();
      
      // Ignora t√≠tulos de se√ß√£o (SectionHeaderItem) - n√£o s√£o campos de dados
      if (itemType === FormApp.ItemType.SECTION_HEADER || itemType === FormApp.ItemType.PAGE_BREAK) {
        sectionHeaders.push(t);
        continue;
      }
      
      formTitles.push(t);
      if (FORM_TO_FIREBASE[t] === undefined) noForm.push(t);
    }
    Logger.log("Itens no formul√°rio ativo: " + formTitles.length + " (campos de dados)");
    if (sectionHeaders.length > 0) {
      Logger.log("   T√≠tulos de se√ß√£o ignorados: " + sectionHeaders.length + " (n√£o s√£o campos de dados)");
    }
    if (noForm.length > 0) {
      Logger.log("‚ö†Ô∏è  Campos no Form N√ÉO mapeados no script: " + noForm.length);
      noForm.forEach(function(t) { Logger.log("   - " + t); });
      Logger.log("   üí° Dica: Se algum desses campos cont√©m dados importantes, adicione ao FORM_TO_FIREBASE.");
    } else {
      Logger.log("‚úÖ Todos os campos de dados do Form est√£o mapeados.");
    }
    var mappedNotInForm = formLabels.filter(function(l) {
      // Ignora "Carimbo de data/hora" - √© autom√°tico do Forms, n√£o aparece como item
      if (l === 'Carimbo de data/hora') return false;
      return formTitles.indexOf(l) === -1;
    });
    if (mappedNotInForm.length > 0) {
      Logger.log("‚ö†Ô∏è  Campos mapeados no script que N√ÉO existem no Form: " + mappedNotInForm.length);
      mappedNotInForm.forEach(function(l) { 
        Logger.log("   - " + l + " -> " + FORM_TO_FIREBASE[l]);
      });
      Logger.log("   üí° Dica: Esses campos podem ter nomes diferentes no Form ou podem ser opcionais.");
    } else {
      Logger.log("‚úÖ Todos os campos mapeados existem no Form (ou s√£o autom√°ticos como 'Carimbo de data/hora').");
    }
  } catch (e) {
    Logger.log("‚ö†Ô∏è  Formul√°rio ativo n√£o dispon√≠vel: " + e.message);
    Logger.log("   Lista de r√≥tulos esperados pelo script (e.namedValues):");
    formLabels.slice(0, 10).forEach(function(l) { Logger.log("   - " + l); });
    Logger.log("   ... e mais " + (formLabels.length - 10) + " campos. Consulte FORM_TO_FIREBASE no c√≥digo.");
  }

  Logger.log("=".repeat(60));
}

/**
 * Fun√ß√£o auxiliar para diagnosticar o formato do evento recebido.
 * Execute esta fun√ß√£o manualmente passando um evento simulado ou use nos logs.
 */
function diagnosticarEvento(e) {
  Logger.log("=".repeat(60));
  Logger.log("üîç DIAGN√ìSTICO DO EVENTO");
  Logger.log("=".repeat(60));
  
  if (!e) {
    Logger.log("‚ùå Evento √© null ou undefined");
    return;
  }
  
  Logger.log("Tipo: " + typeof e);
  Logger.log("Propriedades: " + Object.keys(e).join(', '));
  
  if (e.namedValues) {
    Logger.log("‚úÖ e.namedValues existe");
    Logger.log("   Chaves: " + Object.keys(e.namedValues).slice(0, 5).join(', ') + "...");
  } else {
    Logger.log("‚ùå e.namedValues n√£o existe");
  }
  
  if (e.response) {
    Logger.log("‚úÖ e.response existe");
    try {
      Logger.log("   Tipo: " + typeof e.response);
      if (e.response.getItemResponses) {
        Logger.log("   ‚úÖ √â FormResponse (tem getItemResponses)");
        var itemResponses = e.response.getItemResponses();
        Logger.log("   Total de respostas: " + itemResponses.length);
        if (itemResponses.length > 0) {
          var first = itemResponses[0];
          Logger.log("   Primeira resposta - Item: " + first.getItem().getTitle());
          Logger.log("   Primeira resposta - Resposta: " + first.getResponse());
        }
      } else {
        Logger.log("   ‚ö†Ô∏è  N√£o √© FormResponse (n√£o tem getItemResponses)");
      }
    } catch (err) {
      Logger.log("   ‚ùå Erro ao acessar e.response: " + err.message);
    }
  } else {
    Logger.log("‚ùå e.response n√£o existe");
  }
  
  if (e.source) {
    Logger.log("‚úÖ e.source existe");
    try {
      Logger.log("   Tipo: " + typeof e.source);
      if (e.source.getActiveSheet) {
        Logger.log("   ‚ö†Ô∏è  √â Spreadsheet (script vinculado √† planilha)");
      } else if (e.source.getItems) {
        Logger.log("   ‚úÖ √â Form (script vinculado ao formul√°rio)");
      }
    } catch (err) {
      Logger.log("   Erro ao verificar source: " + err.message);
    }
  }
  
  Logger.log("=".repeat(60));
}